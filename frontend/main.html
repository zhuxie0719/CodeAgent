<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é¡¹ç›®åˆ†æ - Monica</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      color: #111827;
    }

    /* Sidebar */
    .sidebar {
      width: 70px;
      height: 100vh;
      background: #1c2330;
      position: fixed;
      top: 0;
      left: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 10px;
      justify-content: flex-start;
    }

    .sidebar .logo {
      width: 40px;
      height: 40px;
      background: #f7d78c;
      color: #333;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      margin-bottom: 30px;
    }

    .sidebar .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 15px 0;
      color: #bbb;
      font-size: 12px;
      text-align: center;
      cursor: pointer;
      transition: color 0.2s;
    }

    .sidebar .nav-item i {
      font-size: 18px;
      margin-bottom: 5px;
    }

    .sidebar .nav-item:hover {
      color: #fff;
    }

    /* Header */
    .header {
      margin-left: 70px;
      height: 60px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      border-bottom: 1px solid #eee;
    }

    .header nav a {
      margin: 0 15px;
      text-decoration: none;
      color: #444;
      font-weight: 500;
    }

    .header .actions {
      display: flex;
      align-items: center;
      gap: 20px;
      font-size: 18px;
      color: #555;
      cursor: pointer;
    }

    .header .actions i:hover {
      color: #111;
    }

    .header .profile {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: url("https://via.placeholder.com/32") center/cover no-repeat;
      border: 1px solid #ccc;
    }

    /* Main */
    .main {
      margin-left: 70px;
      padding: 20px;
    }

    .project-header {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .project-title-section {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }

    .quality-grade {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      color: white;
    }

    .grade-a { background: #10b981; }
    .grade-b { background: #f59e0b; }
    .grade-c { background: #f59e0b; }
    .grade-d { background: #ef4444; }
    .grade-e { background: #ef4444; }

    .project-info h1 {
      margin: 0 0 8px 0;
      font-size: 24px;
      font-weight: 600;
    }

    .project-description {
      color: #6b7280;
      font-size: 14px;
      margin: 0 0 12px 0;
    }

    .project-meta {
      display: flex;
      gap: 24px;
      font-size: 14px;
      color: #6b7280;
    }

    .lang-bar {
      height: 8px;
      background: #f3f4f6;
      border-radius: 4px;
      display: flex;
      overflow: hidden;
      margin-top: 16px;
    }

    .lang-segment {
      height: 100%;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    .metric-card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .metric-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .metric-title {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
    }

    .metric-grade {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: white;
    }

    .metric-value {
      font-size: 32px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 4px;
    }

    .metric-label {
      font-size: 14px;
      color: #6b7280;
    }

    .quality-gate-section {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .quality-gate-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .quality-gate-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 18px;
      font-weight: 600;
    }

    .status-passed {
      color: #10b981;
    }

    .status-failed {
      color: #ef4444;
    }

    .coverage-duplications {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .coverage-card, .duplications-card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .coverage-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .coverage-title {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
    }

    .coverage-value {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 8px;
    }

    .coverage-description {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 12px;
    }

    .coverage-setup {
      color: #3b82f6;
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .coverage-setup:hover {
      text-decoration: underline;
    }

    .duplications-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .duplications-title {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
    }

    .duplications-value {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 4px;
    }

    .duplications-details {
      font-size: 14px;
      color: #6b7280;
    }

    .issues-section {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .info-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .ai-report-card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .ai-report-actions { display: flex; gap: 10px; margin-top: 10px; }
    .btn { padding: 8px 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .btn-primary { background: #3b82f6; color: #fff; }
    .btn-secondary { background: #10b981; color: #fff; }

    .issues-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .issues-title {
      font-size: 18px;
      font-weight: 600;
      color: #111827;
    }

    .issues-count {
      font-size: 14px;
      color: #6b7280;
    }

    .issue-item {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .issue-item:hover {
      border-color: #3b82f6;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
    }

    .issue-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .issue-severity {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .severity-error {
      background: #fef2f2;
      color: #dc2626;
    }

    .severity-warning {
      background: #fef3c7;
      color: #92400e;
    }

    .severity-info {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .issue-message {
      font-weight: 500;
      color: #111827;
      margin-bottom: 4px;
    }

    .issue-details {
      font-size: 14px;
      color: #6b7280;
    }

    .issue-expanded {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
      display: none;
    }

    .issue-expanded.show {
      display: block;
    }

    .issue-code {
      background: #f8f9fa;
      border-radius: 6px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      margin: 8px 0;
    }

    .issue-fix {
      background: #f0fdf4;
      border-radius: 6px;
      padding: 12px;
      margin-top: 8px;
    }

    .issue-fix-title {
      font-weight: 600;
      color: #166534;
      margin-bottom: 4px;
    }

    .issue-fix-text {
      font-size: 14px;
      color: #15803d;
    }

    /* Files Section Styles */
    .files-section {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .file-item {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .file-item:hover {
      border-color: #3b82f6;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
    }

    .file-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .file-name {
      font-weight: 500;
      color: #111827;
      font-size: 14px;
    }

    .file-language {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      background: #f3f4f6;
      color: #374151;
    }

    .file-issues {
      font-size: 14px;
      color: #6b7280;
    }

    .file-issues.error {
      color: #dc2626;
    }

    .file-issues.warning {
      color: #d97706;
    }

    .file-issues.info {
      color: #2563eb;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">M</div>
    <div class="nav-item">
      <i class="fas fa-home"></i>
      <span>Overview</span>
    </div>
    <div class="nav-item">
      <i class="fas fa-info-circle"></i>
      <span>Information</span>
    </div>
  </aside>

  <!-- Header -->
  <header class="header">
    <nav>
      <a href="projects.html">æˆ‘çš„é¡¹ç›®</a>
      <a href="#">æˆ‘çš„é—®é¢˜</a>
      <a href="explore.html">æ¢ç´¢</a>
    </nav>
    <div class="actions">
      <i class="fas fa-search" title="Search"></i>
      <i class="fas fa-bell" title="Notifications"></i>
      <i class="fas fa-question-circle" title="Help"></i>
      <i class="fas fa-plus" title="Add"></i>
      <div class="profile"></div>
    </div>
  </header>

  <!-- Main -->
  <main class="main">
    <!-- é¡¹ç›®å¤´éƒ¨ -->
    <div class="project-header">
      <div class="project-title-section">
        <div class="quality-grade grade-a">A</div>
        <div class="project-info">
          <h1>Monica</h1>
          <p class="project-description">ä¸ªäºº CRMï¼Œå¸®åŠ©ä½ ç»„ç»‡ç¤¾äº¤å…³ç³»</p>
          <div class="project-meta">
            <span>æ— æ ‡ç­¾</span>
            <span>ä¸Šæ¬¡åˆ†æ 2025å¹´9æœˆ24æ—¥</span>
            <span>45k è¡Œä»£ç </span>
          </div>
        </div>
      </div>
      <div class="lang-bar">
        <div class="lang-segment" style="width: 35%; background: #4f46e5;" title="PHP 35%"></div>
        <div class="lang-segment" style="width: 50%; background: #22c55e;" title="JavaScript 50%"></div>
        <div class="lang-segment" style="width: 10%; background: #a855f7;" title="XML 10%"></div>
        <div class="lang-segment" style="width: 5%; background: #3b82f6;" title="CSS 5%"></div>
      </div>
    </div>

    <!-- è´¨é‡æŒ‡æ ‡ -->
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-title">å®‰å…¨</div>
          <div class="metric-grade grade-a">A</div>
        </div>
        <div class="metric-value">0</div>
        <div class="metric-label">æœªè§£å†³é—®é¢˜</div>
      </div>
      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-title">å¯é æ€§</div>
          <div class="metric-grade grade-c">C</div>
        </div>
        <div class="metric-value">8</div>
        <div class="metric-label">æœªè§£å†³é—®é¢˜</div>
      </div>
      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-title">å¯ç»´æŠ¤æ€§</div>
          <div class="metric-grade grade-a">A</div>
        </div>
        <div class="metric-value">11</div>
        <div class="metric-label">æœªè§£å†³é—®é¢˜</div>
      </div>
    </div>

    <!-- è´¨é‡é˜ˆ -->
    <div class="quality-gate-section">
      <div class="quality-gate-header">
        <h3>è´¨é‡é˜ˆ</h3>
        <div class="quality-gate-status status-passed">
          <i class="fas fa-check-circle"></i>
          é€šè¿‡
        </div>
      </div>
      <p>å·²æ»¡è¶³è´¨é‡é˜ˆçš„æ‰€æœ‰æ¡ä»¶ã€‚</p>
    </div>

    <!-- è¦†ç›–ç‡ä¸é‡å¤ç‡ -->
    <div class="coverage-duplications">
      <div class="coverage-card">
        <div class="coverage-header">
          <div class="coverage-title">è¦†ç›–ç‡</div>
          <i class="fas fa-clock" style="color: #6b7280;"></i>
        </div>
        <div class="coverage-value">85.2%</div>
        <div class="coverage-description">é¡¹ç›®æ•´ä½“æµ‹è¯•è¦†ç›–ç‡è‰¯å¥½</div>
        <a href="#" class="coverage-setup">
          é…ç½®è¦†ç›–ç‡åˆ†æ
          <i class="fas fa-external-link-alt"></i>
        </a>
      </div>
      <div class="duplications-card">
        <div class="duplications-header">
          <div class="duplications-title">é‡å¤ç‡</div>
          <div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%;"></div>
        </div>
        <div class="duplications-value">2.1%</div>
        <div class="duplications-details">45k è¡Œä»£ç æœªè®¾ç½®é˜ˆå€¼</div>
      </div>
    </div>

    <!-- ä¿¡æ¯åŒºï¼ˆAI æŠ¥å‘Š + æ€»é—®é¢˜æ•°ï¼‰ -->
    <div class="info-grid">
      <div class="ai-report-card">
        <div style="display:flex;align-items:center;justify-content:space-between; margin-bottom:8px;">
          <div class="coverage-title">AI æŠ¥å‘Š</div>
          <div id="aiReportStatus" style="font-size:12px;color:#6b7280;">æœªåŠ è½½</div>
        </div>
        <div id="aiReportPreview" style="white-space: pre-wrap; max-height: 150px; overflow: auto; background:#f8f9fa; border-radius:8px; padding:12px; font-size:13px; color:#111827;">æš‚æ—  AI æŠ¥å‘Šã€‚</div>
        <div class="ai-report-actions">
          <button class="btn btn-primary" id="viewAIReportBtn">æŸ¥çœ‹å…¨æ–‡</button>
          <button class="btn btn-secondary" id="downloadAIReportBtn">ä¸‹è½½</button>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-title">æ€»é—®é¢˜æ•°</div>
          <div class="metric-grade grade-a">A</div>
        </div>
        <div class="metric-value" id="totalIssuesValue">0</div>
        <div class="metric-label">æ‰€æœ‰é—®é¢˜çš„æ€»å’Œ</div>
      </div>
    </div>

    <!-- Files Analyzed Section (for project analysis) -->
    <div class="files-section" id="filesSection" style="display: none;">
      <div class="issues-header">
        <div class="issues-title">å·²åˆ†æçš„æ–‡ä»¶</div>
        <div class="issues-count" id="filesCount">0 ä¸ªæ–‡ä»¶</div>
      </div>
      <div id="filesList">
        <!-- Files will be populated by JavaScript -->
      </div>
    </div>

    <!-- Issues Section -->
    <div class="issues-section">
      <div class="issues-header">
        <div class="issues-title">æ£€æµ‹åˆ°çš„é—®é¢˜</div>
        <div class="issues-count">0 ä¸ªé—®é¢˜</div>
      </div>
      <div id="issuesList">
        <!-- Issues will be populated by JavaScript -->
      </div>
    </div>
  </main>

  <script>
    // Load analysis results from localStorage
    let analysisResult = null;
    let fileName = 'Monica';
    let taskId = null;
    let analysisType = 'file';
    let structuredData = null;

    // Check if we have analysis results from index.html
    function loadAnalysisData() {
      const storedResult = localStorage.getItem('analysisResult');
      const storedFileName = localStorage.getItem('fileName');
      const storedTaskId = localStorage.getItem('taskId');
      const storedAnalysisType = localStorage.getItem('analysisType');
      const storedStructuredData = localStorage.getItem('structuredData');
      
      if (storedResult) {
        analysisResult = JSON.parse(storedResult);
        fileName = storedFileName || 'Uploaded File';
        taskId = storedTaskId;
        analysisType = storedAnalysisType || 'file';
        structuredData = storedStructuredData ? JSON.parse(storedStructuredData) : null;
        
        // Clear the stored data
        localStorage.removeItem('analysisResult');
        localStorage.removeItem('fileName');
        localStorage.removeItem('taskId');
        localStorage.removeItem('analysisType');
        localStorage.removeItem('structuredData');
        
        // Update the page with real data
        updatePageWithAnalysisData();
      } else {
        // Use default sample data
        loadDefaultData();
      }
    }

    function loadDefaultData() {
      const issues = [
        {
          id: 1,
          severity: 'warning',
          message: 'Avoid using hardcoded credentials',
          file: 'config/database.php',
          line: 23,
          type: 'Security Hotspot',
          code: 'DB_PASSWORD = "mypassword123"',
          fix: 'Use environment variables or a secure configuration management system'
        },
        {
          id: 2,
          severity: 'error',
          message: 'SQL injection vulnerability detected',
          file: 'models/User.php',
          line: 45,
          type: 'Bug',
          code: 'SELECT * FROM users WHERE id = ' + userId,
          fix: 'Use prepared statements: SELECT * FROM users WHERE id = ?'
        },
        {
          id: 3,
          severity: 'info',
          message: 'Consider using a more descriptive variable name',
          file: 'controllers/AuthController.php',
          line: 12,
          type: 'Code Smell',
          code: 'var $x = getUserData();',
          fix: 'Use a descriptive name like $userData = getUserData();'
        }
      ];
      
      // æ›´æ–°é¡µé¢æ˜¾ç¤º
      document.querySelector('.issues-count').textContent = `${issues.length} ä¸ªé—®é¢˜`;
      document.getElementById('totalIssuesValue').textContent = issues.length;
      document.getElementById('filesCount').textContent = '1 ä¸ªæ–‡ä»¶';
      
      // æ›´æ–°è´¨é‡æŒ‡æ ‡
      const errorCount = issues.filter(issue => issue.severity === 'error').length;
      const warningCount = issues.filter(issue => issue.severity === 'warning').length;
      const infoCount = issues.filter(issue => issue.severity === 'info').length;
      
      // æ›´æ–°å®‰å…¨ã€å¯é æ€§ã€å¯ç»´æŠ¤æ€§æŒ‡æ ‡
      document.querySelector('.metric-card:nth-child(1) .metric-value').textContent = errorCount;
      document.querySelector('.metric-card:nth-child(2) .metric-value').textContent = warningCount;
      document.querySelector('.metric-card:nth-child(3) .metric-value').textContent = infoCount;
      
      // æ›´æ–°è´¨é‡é—¨
      const totalIssues = errorCount + warningCount + infoCount;
      if (totalIssues === 0) {
        document.querySelector('.quality-gate-section .status').textContent = 'Passed';
        document.querySelector('.quality-gate-section .status').className = 'status passed';
        document.querySelector('.quality-gate-section p').textContent = 'All conditions have been met for the quality gate.';
      } else {
        document.querySelector('.quality-gate-section .status').textContent = 'Failed';
        document.querySelector('.quality-gate-section .status').className = 'status failed';
        document.querySelector('.quality-gate-section p').textContent = `${totalIssues} issues need to be resolved to pass the quality gate.`;
      }
      
      renderIssues(issues);
    }

    function updatePageWithAnalysisData() {
      if (!analysisResult) return;

      const detectionResults = analysisResult.detection_results;
      const summary = detectionResults.summary;
      
      // Update project name and description
      document.querySelector('.project-info h1').textContent = fileName;
      const description = analysisType === 'project' ? 
        `é¡¹ç›®åˆ†æç»“æœ - ${detectionResults.total_files || 1} ä¸ªæ–‡ä»¶` : 
        'å•æ–‡ä»¶åˆ†æç»“æœ';
      document.querySelector('.project-description').textContent = description;
      
      // Update project meta info
      const metaInfo = document.querySelector('.project-meta');
      if (analysisType === 'project') {
        metaInfo.innerHTML = `
          <span>${detectionResults.languages_detected ? detectionResults.languages_detected.join(', ') : 'æœªçŸ¥è¯­è¨€'}</span>
          <span>ä¸Šæ¬¡åˆ†æ ${new Date().toLocaleDateString()}</span>
          <span>${detectionResults.total_files || 1} ä¸ªæ–‡ä»¶</span>
        `;
      } else {
        metaInfo.innerHTML = `
          <span>${detectionResults.language || 'æœªçŸ¥è¯­è¨€'}</span>
          <span>ä¸Šæ¬¡åˆ†æ ${new Date().toLocaleDateString()}</span>
          <span>å•æ–‡ä»¶åˆ†æ</span>
        `;
      }
      
      // Update metrics
      updateMetrics(summary);
      
      // Update quality gate
      updateQualityGate(summary);
      
      // Update coverage and duplications
      updateCoverageAndDuplications(summary);
      
      // Update files list (for project analysis)
      if (analysisType === 'project' && detectionResults.files_analyzed) {
        renderFiles(detectionResults.files_analyzed);
        document.getElementById('filesSection').style.display = 'block';
        document.getElementById('filesCount').textContent = `${detectionResults.files_analyzed.length} ä¸ªæ–‡ä»¶`;
      } else {
        document.getElementById('filesSection').style.display = 'none';
      }

      // Update totals and issues
      if (detectionResults.issues && detectionResults.issues.length > 0) {
        renderIssues(detectionResults.issues);
        document.querySelector('.issues-count').textContent = `${detectionResults.issues.length} ä¸ªé—®é¢˜`;
        const total = detectionResults.total_issues ?? (summary.error_count + summary.warning_count + summary.info_count);
        document.getElementById('totalIssuesValue').textContent = total;
      } else {
        document.querySelector('.issues-count').textContent = '0 ä¸ªé—®é¢˜';
        document.getElementById('issuesList').innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;">ğŸ‰ æ­å–œï¼æœªå‘ç°ä»»ä½•é—®é¢˜</div>';
        document.getElementById('totalIssuesValue').textContent = 0;
      }

      // Load AI report
      loadAIReport();
      
      // Add structured data download button if available
      if (structuredData) {
        addStructuredDataButton();
      }
    }

    function updateMetrics(summary) {
      // Security
      const securityCard = document.querySelector('.metric-card:nth-child(1)');
      securityCard.querySelector('.metric-value').textContent = summary.error_count || 0;
      const securityGrade = getGradeFromCount(summary.error_count || 0);
      securityCard.querySelector('.metric-grade').textContent = securityGrade;
      securityCard.querySelector('.metric-grade').className = `metric-grade grade-${securityGrade.toLowerCase()}`;
      
      // Reliability  
      const reliabilityCard = document.querySelector('.metric-card:nth-child(2)');
      reliabilityCard.querySelector('.metric-value').textContent = summary.warning_count || 0;
      const reliabilityGrade = getGradeFromCount(summary.warning_count || 0);
      reliabilityCard.querySelector('.metric-grade').textContent = reliabilityGrade;
      reliabilityCard.querySelector('.metric-grade').className = `metric-grade grade-${reliabilityGrade.toLowerCase()}`;
      
      // Maintainability
      const maintainabilityCard = document.querySelector('.metric-card:nth-child(3)');
      maintainabilityCard.querySelector('.metric-value').textContent = summary.info_count || 0;
      const maintainabilityGrade = getGradeFromCount(summary.info_count || 0);
      maintainabilityCard.querySelector('.metric-grade').textContent = maintainabilityGrade;
      maintainabilityCard.querySelector('.metric-grade').className = `metric-grade grade-${maintainabilityGrade.toLowerCase()}`;
    }

    function getGradeFromCount(count) {
      if (count === 0) return 'A';
      if (count <= 5) return 'B';
      if (count <= 15) return 'C';
      if (count <= 30) return 'D';
      return 'E';
    }

    function updateQualityGate(summary) {
      const totalIssues = summary.error_count + summary.warning_count + summary.info_count;
      const qualityGateStatus = document.querySelector('.quality-gate-status');
      
      if (totalIssues === 0) {
        qualityGateStatus.innerHTML = '<i class="fas fa-check-circle"></i> Passed';
        qualityGateStatus.className = 'quality-gate-status status-passed';
        document.querySelector('.quality-gate-section p').textContent = 'All conditions have been met for the quality gate.';
      } else {
        qualityGateStatus.innerHTML = '<i class="fas fa-times-circle"></i> Failed';
        qualityGateStatus.className = 'quality-gate-status status-failed';
        document.querySelector('.quality-gate-section p').textContent = `${totalIssues} issues need to be resolved to pass the quality gate.`;
      }
    }

    function updateCoverageAndDuplications(summary) {
      // Update coverage (mock data for now)
      const coverageValue = document.querySelector('.coverage-value');
      coverageValue.textContent = '85.2%';
      
      // Update duplications (mock data for now)
      const duplicationsValue = document.querySelector('.duplications-value');
      duplicationsValue.textContent = '2.1%';
    }

    function renderFiles(files) {
      const filesList = document.getElementById('filesList');
      filesList.innerHTML = files.map((file, index) => {
        const fileName = file.file_path.split('/').pop() || file.file_path.split('\\').pop() || 'Unknown';
        const issueCount = file.total_issues || 0;
        const errorCount = file.issues.filter(issue => issue.severity === 'error').length;
        const warningCount = file.issues.filter(issue => issue.severity === 'warning').length;
        const infoCount = file.issues.filter(issue => issue.severity === 'info').length;
        
        let issueText = '';
        if (issueCount === 0) {
          issueText = '<span style="color: #10b981;">âœ“ æ— é—®é¢˜</span>';
        } else {
          const parts = [];
          if (errorCount > 0) parts.push(`<span class="file-issues error">${errorCount} é”™è¯¯</span>`);
          if (warningCount > 0) parts.push(`<span class="file-issues warning">${warningCount} è­¦å‘Š</span>`);
          if (infoCount > 0) parts.push(`<span class="file-issues info">${infoCount} ä¿¡æ¯</span>`);
          issueText = parts.join(', ');
        }
        
        return `
          <div class="file-item" onclick="toggleFileIssues(${index + 1})">
            <div class="file-header">
              <div class="file-name">${fileName}</div>
              <div class="file-language">${file.language || 'unknown'}</div>
            </div>
            <div class="file-issues">
              ${issueText}
            </div>
            <div class="file-expanded" id="file-${index + 1}" style="display: none;">
              ${file.issues.length > 0 ? `
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                  <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #374151;">é—®é¢˜è¯¦æƒ…:</h4>
                  ${file.issues.map(issue => `
                    <div style="margin: 8px 0; padding: 8px; background: #f9fafb; border-radius: 4px;">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <span class="issue-severity severity-${issue.severity}" style="font-size: 11px; padding: 2px 6px;">
                          ${issue.severity.toUpperCase()}
                        </span>
                        <span style="font-size: 12px; color: #6b7280;">ç¬¬ ${issue.line} è¡Œ</span>
                      </div>
                      <div style="font-size: 13px; color: #374151;">${issue.message}</div>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderIssues(issues) {
      const issuesList = document.getElementById('issuesList');
      issuesList.innerHTML = issues.map((issue, index) => `
        <div class="issue-item" onclick="toggleIssue(${index + 1})">
          <div class="issue-header">
            <div class="issue-severity severity-${issue.severity}">
              ${issue.severity.toUpperCase()}
            </div>
            <div style="font-size: 12px; color: #6b7280;">
              ${issue.file}:${issue.line}
            </div>
          </div>
          <div class="issue-message">${issue.message || issue.detailed_description || 'No message available'}</div>
          <div class="issue-details">${issue.type}</div>
          <div class="issue-expanded" id="issue-${index + 1}">
            <div class="issue-code">${issue.code_snippet ? issue.code_snippet.map(line => line.content).join('\n') : 'No code snippet available'}</div>
            <div class="issue-fix">
              <div class="issue-fix-title">Suggested Fix:</div>
              <div class="issue-fix-text">${issue.fix_suggestions ? issue.fix_suggestions.join('; ') : 'No fix suggestions available'}</div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function toggleIssue(issueId) {
      const expanded = document.getElementById(`issue-${issueId}`);
      expanded.classList.toggle('show');
    }

    function toggleFileIssues(fileId) {
      const expanded = document.getElementById(`file-${fileId}`);
      expanded.style.display = expanded.style.display === 'none' ? 'block' : 'none';
    }

    function loadAIReport() {
      const apiBase = localStorage.getItem('apiBase');
      const cachedReport = localStorage.getItem('aiReport');
      const cachedDownload = localStorage.getItem('aiReportDownloadUrl');
      const aiReportPreview = document.getElementById('aiReportPreview');
      const aiReportStatus = document.getElementById('aiReportStatus');

      const setReport = (text, downloadUrl) => {
        aiReportPreview.textContent = text ? (text.length > 600 ? text.slice(0, 600) + 'â€¦' : text) : 'No AI report available.';
        aiReportStatus.textContent = text ? 'Loaded' : 'Not available';
        // Wire buttons
        document.getElementById('viewAIReportBtn').onclick = () => {
          if (!text) return;
          const modal = document.createElement('div');
          modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;';
          const box = document.createElement('div');
          box.style.cssText = 'max-width:80%;max-height:80%;overflow:auto;background:#fff;border-radius:10px;padding:20px;position:relative;';
          const close = document.createElement('button');
          close.textContent = 'Ã—';
          close.style.cssText = 'position:absolute;top:8px;right:12px;border:none;background:none;font-size:22px;cursor:pointer;color:#666;';
          close.onclick = () => modal.remove();
          const pre = document.createElement('pre');
          pre.style.whiteSpace = 'pre-wrap';
          pre.textContent = text;
          box.appendChild(close); box.appendChild(pre); modal.appendChild(box); document.body.appendChild(modal);
        };
        document.getElementById('downloadAIReportBtn').onclick = () => {
          if (downloadUrl) {
            window.open(downloadUrl, '_blank');
          } else if (text) {
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = (fileName || 'ai_report') + '.txt'; a.click();
            URL.revokeObjectURL(url);
          }
        };
      };

      if (cachedReport) {
        setReport(cachedReport, cachedDownload || null);
        localStorage.removeItem('aiReport');
        localStorage.removeItem('aiReportDownloadUrl');
        return;
      }

      if (apiBase && taskId) {
        fetch(`${apiBase}/api/v1/ai-reports/${taskId}`).then(r => r.json()).then(data => {
          if (data && data.success && data.data && data.data.ai_report) {
            setReport(data.data.ai_report, `${apiBase}/api/v1/ai-reports/${taskId}/download`);
          } else {
            setReport('', null);
          }
        }).catch(() => setReport('', null));
      } else {
        setReport('', null);
      }
    }

    function addStructuredDataButton() {
      // Add structured data download button to AI report section
      const aiReportCard = document.querySelector('.ai-report-card');
      const existingActions = aiReportCard.querySelector('.ai-report-actions');
      
      if (existingActions && !existingActions.querySelector('.btn-structured')) {
        const structuredBtn = document.createElement('button');
        structuredBtn.className = 'btn btn-secondary btn-structured';
        structuredBtn.textContent = 'ğŸ“Š ä¸‹è½½ç»“æ„åŒ–æ•°æ®';
        structuredBtn.onclick = downloadStructuredData;
        existingActions.appendChild(structuredBtn);
      }
    }

    function downloadStructuredData() {
      const downloadUrl = localStorage.getItem('structuredDataDownloadUrl');
      if (downloadUrl) {
        window.open(downloadUrl, '_blank');
      } else if (structuredData) {
        // Fallback: create download from stored data
        const blob = new Blob([JSON.stringify(structuredData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `structured_data_${taskId || 'analysis'}.json`;
        a.click();
        URL.revokeObjectURL(url);
      } else {
        alert('ç»“æ„åŒ–æ•°æ®ä¸å¯ç”¨');
      }
    }

    // Initialize
    loadAnalysisData();
  </script>
</body>
</html>
