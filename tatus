import os
import requests
import re

class LLMFixer:
    """é€šç”¨ LLM ä¿®å¤å·¥å…·ï¼Œä¾¿äºåç»­æ‰©å±•ä¸åŒå¤§æ¨¡å‹"""
    def __init__(self, api_key=None, model="deepseek-coder", base_url="https://api.deepseek.com/v1/chat/completions"):
        self.api_key = api_key or "sk-75db9bf464d44ee78b5d45a655431710"
        self.model = model
        self.base_url = base_url

    def fix_code(self, code, language, message):
        """
        è°ƒç”¨ LLM ä¿®å¤ä»£ç ï¼Œè¿”å›ä¿®å¤åçš„çº¯ä»£ç 
        """
        prompt = (
            f"è¯·ä¿®å¤ä»¥ä¸‹{language}ä»£ç ä¸­çš„é—®é¢˜ï¼š\n"
            f"{code}\n\n"
            f"# é—®é¢˜æè¿°ï¼š{message}\n"
            f"\nè¯·åªè¾“å‡ºä¿®å¤åçš„å®Œæ•´ä»£ç ï¼Œä¸è¦ä»»ä½•è§£é‡Šã€æ³¨é‡Šæˆ– markdown æ ¼å¼ã€‚"
        )
        headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        }
        data = {
            "model": self.model,
            "messages": [
                {"role": "system", "content": "ä½ æ˜¯ä¸“ä¸šçš„ä»£ç ä¿®å¤åŠ©æ‰‹ã€‚"},
                {"role": "user", "content": prompt}
            ],
            "temperature": 0.2,
            "max_tokens": 2048
        }
        resp = requests.post(self.base_url, headers=headers, json=data, timeout=60)
        resp.raise_for_status()
        result = resp.json()
        llm_content = result["choices"][0]["message"]["content"]
        code_match = re.search(r"```[a-zA-Z]*\n([\s\S]*?)```", llm_content)
        if code_match:
            llm_code = code_match.group(1).strip()
        else:
            llm_code = llm_content.strip()
        return llm_code

    def fix_code_multi(self, code: str, language: str, issues: list) -> str:
        """
        è°ƒç”¨ LLM ä¿®å¤ä»£ç ï¼ˆå¤šé—®é¢˜æ±‡æ€»ï¼‰ï¼›issues ä¸ºé—®é¢˜åˆ—è¡¨ï¼ˆå« message/line ç­‰ï¼‰ï¼Œè¿”å›ä¿®å¤åçš„çº¯ä»£ç 
        """
        # æ„å»ºå¤šé—®é¢˜è¯´æ˜
        summarized = []
        for i, issue in enumerate(issues, start=1):
            msg = issue.get("message", "")
            line = issue.get("line")
            symbol = issue.get("symbol") or issue.get("type")
            summarized.append(f"{i}. line={line}, type={symbol}, message={msg}")
        issues_text = "\n".join(summarized) if summarized else "æ— "

        prompt = (
            f"è¯·åŸºäºä»¥ä¸‹{language}å®Œæ•´æ–‡ä»¶å†…å®¹ï¼Œä¿®å¤ä¸‹è¿°æ‰€æœ‰é—®é¢˜ï¼š\n"
            f"\n===== æºä»£ç  BEGIN =====\n{code}\n===== æºä»£ç  END =====\n"
            f"\n===== é—®é¢˜åˆ—è¡¨ BEGIN =====\n{issues_text}\n===== é—®é¢˜åˆ—è¡¨ END =====\n"
            f"\nè¦æ±‚ï¼š\n"
            f"1) ä¿æŒåŸæœ‰åŠŸèƒ½ä¸å˜ï¼›\n"
            f"2) ä¸€æ¬¡æ€§ä¿®å¤æ‰€æœ‰é—®é¢˜ï¼›\n"
            f"3) åªè¾“å‡ºä¿®å¤åçš„å®Œæ•´ä»£ç ï¼Œä¸è¦ä»»ä½•è§£é‡Šã€æ³¨é‡Šæˆ– markdownã€‚\n"
        )

        headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        }
        data = {
            "model": self.model,
            "messages": [
                {"role": "system", "content": "ä½ æ˜¯ä¸“ä¸šçš„ä»£ç ä¿®å¤åŠ©æ‰‹ã€‚"},
                {"role": "user", "content": prompt}
            ],
            "temperature": 0.2,
            "max_tokens": 4096
        }
        resp = requests.post(self.base_url, headers=headers, json=data, timeout=120)
        resp.raise_for_status()
        result = resp.json()
        llm_content = result["choices"][0]["message"]["content"]
        code_match = re.search(r"```[a-zA-Z]*\n([\s\S]*?)```", llm_content)
        if code_match:
            llm_code = code_match.group(1).strip()
        else:
            llm_code = llm_content.strip()
        return llm_code* [33m743e2a5[m[33m ([m[1;31mupstream/main[m[33m)[m ä¿®æ”¹å‰ç«¯é¡µé¢
*   [33mb320303[m Merge pull request #11 from xiaobai-cn21/main
[32m|[m[33m\[m  
[32m|[m * [33m76e5363[m å¿˜äº†push
[32m|[m[32m/[m  
*   [33m83538b4[m Merge pull request #10 from AltheD/main
[34m|[m[35m\[m  
[34m|[m * [33m18d4186[m[33m ([m[1;36mHEAD -> [m[1;32mmain[m[33m, [m[1;31morigin/main[m[33m, [m[1;31morigin/HEAD[m[33m)[m fix: stabilize startup by lazy agent imports; improve AI quality report flow and main page rendering; fix quality-gate selector and grade class handling
[34m|[m[34m/[m  
* [33mf9689a5[m chore: remove conflicted backup files
*   [33m302f28d[m åˆ†æå’Œè´¨é‡agent
[36m|[m[1;31m\[m  
[36m|[m *   [33m14bc873[m Merge branch 'main' into main
[36m|[m [1;32m|[m[36m\[m  
[36m|[m [1;32m|[m[36m/[m  
[36m|[m[36m/[m[1;32m|[m   
* [1;32m|[m   [33m1155835[m Merge pull request #8 from BreezeLune/main
[1;34m|[m[1;35m\[m [1;32m\[m  
[1;34m|[m * [1;32m|[m [33md89b6b0[m æ·»åŠ coordinatoræµç¨‹å›¾
